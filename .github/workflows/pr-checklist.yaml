name: PR Checklist Generator

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - ecu/xpad/xpad-shared/platform_tests/**
      - platform/aas/test/**

permissions:
  pull-requests: write
  contents: read

jobs:
  pr-checklist-testing:
    name: PR Checklist Generator for testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v39

      - name: Detect external/internal relevant changes
        id: detect
        run: |
          changedRaw="${{ steps.changed-files.outputs.all_changed_files }}"
          addedRaw="${{ steps.changed-files.outputs.added_files }}"

          # Path variables (keep these near the top so they're easy to find)
          external_path="ecu/xpad/xpad-shared/platform_tests/"
          internal_path="platform/aas/test/"

          # Regex variables for internal tests (do not hardcode in conditionals)
          py_regex='^test_.*\.py$'
          cpp_regex='_test\.cpp$'

          has_external=false
          has_internal=false

          # Detect any change or new file under external path
          if [[ -n "$changedRaw" ]]; then
            while IFS= read -r f; do
              if [[ "$f" == ${external_path}* ]]; then
                has_external=true
                break
              fi
            done <<< "$changedRaw"
          fi
          if [[ "$has_external" != true && -n "$addedRaw" ]]; then
            while IFS= read -r f; do
              if [[ "$f" == ${external_path}* ]]; then
                has_external=true
                break
              fi
            done <<< "$addedRaw"
          fi

          # Detect internal test file changes (changed or added) that match regex
          if [[ -n "$changedRaw" ]]; then
            while IFS= read -r f; do
              if [[ "$f" == ${internal_path}* ]]; then
                filename="${f##*/}"
                if [[ "$filename" =~ $py_regex ]] || [[ "$filename" =~ $cpp_regex ]]; then
                  has_internal=true
                  break
                fi
              fi
            done <<< "$changedRaw"
          fi
          if [[ "$has_internal" != true && -n "$addedRaw" ]]; then
            while IFS= read -r f; do
              if [[ "$f" == ${internal_path}* ]]; then
                filename="${f##*/}"
                if [[ "$filename" =~ $py_regex ]] || [[ "$filename" =~ $cpp_regex ]]; then
                  has_internal=true
                  break
                fi
              fi
            done <<< "$addedRaw"
          fi

          echo "has-external=$has_external" >> $GITHUB_OUTPUT
          echo "has-internal=$has_internal" >> $GITHUB_OUTPUT

      - name: Update PR description with checklists
        uses: actions/github-script@v6
        env:
          HAS_EXTERNAL: ${{ steps.detect.outputs.has-external }}
          HAS_INTERNAL: ${{ steps.detect.outputs.has-internal }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const hasExternal = process.env.HAS_EXTERNAL === 'true';
            const hasInternal = process.env.HAS_INTERNAL === 'true';

            if (!hasExternal && !hasInternal) {
              console.log('No relevant testing changes detected. Exiting.');
              return;
            }

            // Use the platform test dev checklist
            const checklistPath = '.github/PULL_REQUEST_TEMPLATE/platform_test_dev_checklist.md';
            let checklistContent = '';
            if (fs.existsSync(checklistPath)) {
              try {
                checklistContent = fs.readFileSync(checklistPath, 'utf8');
                console.log(`Using checklist: ${checklistPath}`);
              } catch (err) {
                console.log(`Failed reading ${checklistPath}: ${err}`);
              }
            } else {
              console.log(`Checklist file not found at ${checklistPath}`);
            }

            if (!checklistContent) {
              console.log('No checklist content to add.');
              return;
            }

            const parts = [];
            if (hasExternal) parts.push('### External Testing Checklist\n\n' + checklistContent);
            if (hasInternal) parts.push('### Internal Testing Checklist\n\n' + checklistContent);

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.issue.number;

            const pr = await github.rest.pulls.get({ owner, repo, pull_number });
            const currentBody = pr.data.body || '';

            const baseBody = currentBody.split('\n## PR Checklists\n')[0].trim();
            const header = '## PR Checklists\n\n';
            const checklists = parts.join('\n\n');
            let updatedBody = '';
            if (baseBody) {
              updatedBody = baseBody + '\n\n' + header + checklists;
            } else {
              updatedBody = header + checklists;
            }

            await github.rest.pulls.update({ owner, repo, pull_number, body: updatedBody });
            console.log('PR description updated with testing checklist(s).');
