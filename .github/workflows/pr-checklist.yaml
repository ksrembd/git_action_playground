name: PR Checklist Generator

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'Platform_testing/ut/**'
      - 'Platform_testing/gt/**'
      - 'Platform_testing/qm/**'
      - 'Platform_testing/fusa/**'

permissions:
  pull-requests: write
  contents: read

jobs:
  generate-checklists:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v39

      - name: Update PR description with checklists
        uses: actions/github-script@v6
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const changedRaw = process.env.CHANGED_FILES || '';
            const changed = changedRaw.split(/\r?\n/).filter(Boolean);

            const need = { ut: false, gt: false, qm: false, fusa: false };
            for (const f of changed) {
              if (f.startsWith('Platform_testing/ut/')) need.ut = true;
              else if (f.startsWith('Platform_testing/gt/')) need.gt = true;
              else if (f.startsWith('Platform_testing/qm/')) need.qm = true;
              else if (f.startsWith('Platform_testing/fusa/')) need.fusa = true;
            }

            if (!need.ut && !need.gt && !need.qm && !need.fusa) {
              console.log('No relevant Platform_testing changes detected. Exiting.');
              return;
            }

            // Use the recommended plural workflows folder only
            const checklistDir = '.github/workflows/checklists';
            let filesInDir = [];
            if (fs.existsSync(checklistDir)) {
              filesInDir = fs.readdirSync(checklistDir);
              console.log(`Using checklist folder: ${checklistDir}`);
            } else {
              console.log(`Checklist folder not found at ${checklistDir}`);
            }

            const lowerMap = {};
            for (const fn of filesInDir) {
              lowerMap[fn.toLowerCase()] = fn;
            }

            const want = [];
            if (need.ut) want.push('ut_checklist.md');
            if (need.gt) want.push('gt_checklist.md');
            if (need.qm) want.push('qm_checklist.md');
            if (need.fusa) want.push('fusa_checklist.md');

            const parts = [];
            for (const w of want) {
              const found = lowerMap[w];
              if (found) {
                try {
                  const content = fs.readFileSync(path.join(checklistDir, found), 'utf8');
                  parts.push(`### ${w.replace('_checklist.md','').toUpperCase()} Checklist\n\n` + content);
                } catch (err) {
                  console.log(`Failed reading ${found}: ${err}`);
                }
              } else {
                console.log(`Checklist file not found for ${w} (case-insensitive search)`);
              }
            }

            if (parts.length === 0) {
              console.log('No checklist content to add.');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.issue.number;

            const pr = await github.rest.pulls.get({ owner, repo, pull_number });
            const currentBody = pr.data.body || '';

            const baseBody = currentBody.split('\n## PR Checklists\n')[0].trim();
            const updatedBody = (baseBody ? baseBody + '\n\n' : '') + '## PR Checklists\n\n' + parts.join('\n\n');

            await github.rest.pulls.update({ owner, repo, pull_number, body: updatedBody });
            console.log('PR description updated with checklists.');
