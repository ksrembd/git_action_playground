name: PR Checklist Generator

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'ecu/xpad/xpad-shared/platform_tests/**'
      - 'platform/aas/test/**'

permissions:
  pull-requests: write
  contents: read

jobs:
  generate-checklists:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v39

      - name: Update PR description with checklists
        uses: actions/github-script@v6
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const changedRaw = process.env.CHANGED_FILES || '';
            const changed = changedRaw.split(/\r?\n/).filter(Boolean);

            const hasRelevantChanges = changed.some(f =>
              f.startsWith('ecu/xpad/xpad-shared/platform_tests/') ||
              f.startsWith('platform/aas/test/')
            );

            if (!hasRelevantChanges) {
              console.log('No relevant platform test changes detected. Exiting.');
              return;
            }

            // Use the platform test dev checklist
            const checklistPath = '.github/PULL_REQUEST_TEMPLATE/platform_test_dev_checklist.md';
            let checklistContent = '';
            if (fs.existsSync(checklistPath)) {
              try {
                checklistContent = fs.readFileSync(checklistPath, 'utf8');
                console.log(`Using checklist: ${checklistPath}`);
              } catch (err) {
                console.log(`Failed reading ${checklistPath}: ${err}`);
              }
            } else {
              console.log(`Checklist file not found at ${checklistPath}`);
            }

            if (!checklistContent) {
              console.log('No checklist content to add.');
              return;
            }

            const parts = [`### Platform Test Checklist\n\n` + checklistContent];

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.issue.number;

            const pr = await github.rest.pulls.get({ owner, repo, pull_number });
            const currentBody = pr.data.body || '';

            const baseBody = currentBody.split('\n## PR Checklists\n')[0].trim();
            const updatedBody = (baseBody ? baseBody + '\n\n' : '') + '## PR Checklists\n\n' + parts.join('\n\n');

            await github.rest.pulls.update({ owner, repo, pull_number, body: updatedBody });
            console.log('PR description updated with checklists.');
